<dime-box label="Services">
  <div boxBody ngControlGroup="offerpositions" #overview="ngForm">
    <table class="table table-bordered table-hover" >
      <thead>
        <tr>
          <th>Reihenfolge</th>
          <th class="col-sm-4">Service</th>
          <th>Tarif</th>
          <th>Tarif Einheit</th>
          <th>Einheits-Typ</th>
          <th>Menge</th>
          <th>MwSt.</th>
          <th>Rabattierbar</th>
          <th>Total</th>
          <th width="60">Aktion</th>
        </tr>
      </thead>
      <tbody *ngIf="entities != null">
        <tr
          *ngFor="let entity of entities | orderBy:'order' ; let i = index"
          (click)="selectEntity(entity.id)"
          [ngClass]="rowClass(entity, row.valid)"
          ngControlGroup="position{{i}}"
          #row="ngForm">
          <td validationStatus class="form-group">
            <input ngControl="order{{i}}" class="form-control" type="number"
                   [(ngModel)]="entity.order" (change)="addSaveField('order', entity)"/></td>
          <td validationStatus class="form-group">
            <service-select required ngControl="service{{i}}" hideArchived
                            [ngModel]="entity.service" (ngModelChange)="entity.service=$event;entity.addFieldtoUpdate('service')"></service-select></td>
          <td validationStatus class="form-group">
            <input required ngControl="rateValue{{i}}" class="form-control"
                   [(ngModel)]="entity.rateValue" (change)="addSaveField('rateValue', entity)"/></td>
          <td validationStatus class="form-group">
            <input required ngControl="rateUnit{{i}}" class="form-control"
                   [(ngModel)]="entity.rateUnit" (change)="addSaveField('rateUnit', entity)"/></td>
          <td validationStatus class="form-group">
            <rate-unit-type-select required ngControl="rateUnitType{{i}}"
                                 [ngModel]="entity.rateUnitType" (ngModelChange)="entity.rateUnitType=$event;entity.addFieldtoUpdate('rateUnitType')"></rate-unit-type-select></td>
          <td validationStatus class="form-group">
            <input required ngControl="amount{{i}}" class="form-control" type="number"
                   [(ngModel)]="entity.amount" (change)="addSaveField('amount', entity)"/></td>
          <td validationStatus class="form-group">
            <percentage-input required ngControl="vat{{i}}"
                              [ngModel]="entity.vat" (ngModelChange)="entity.vat=$event;addSaveField('vat', entity)"></percentage-input></td>
          <td><input class="checkbox" type="checkbox" [(ngModel)]="entity.discountable" (change)="addSaveField('discountable', entity)"/></td>
          <td>{{entity.total}}</td>
          <td><dime-button (click)="deleteEntity(entity.id)" fontAwesome="trash-o" color="red"></dime-button></td>
        </tr>
      </tbody>
    </table>
  </div>
  <div boxFooter class="DimeControlButtons">
    <!-- FIXME the current workflow is as follows:
      1. add a new position
      2. choose a service
      3. save the form
      => saving then pulls in the other fields of the position based on the selected service

      This isn't very clean. Improve it by triggering a save on selecting the service, so the rest of the fields get pulled in immediately
    -->
    <dime-button primary (click)="createEntity()" glyphicon="plus">Hinzuf√ºgen</dime-button>
    <dime-button primary (click)="duplicateEntity()" fontAwesome="copy">Duplizieren</dime-button>
    <dime-button (click)="reloadEvict()" glyphicon="refresh"></dime-button>
  </div>
</dime-box>

