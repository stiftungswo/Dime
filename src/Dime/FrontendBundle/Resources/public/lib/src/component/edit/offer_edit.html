<h2 class="page-header">{{entity?.name}}&nbsp;</h2>

<form *ngIf="entity != null" class="box-body" #editform="ngForm">
  <div class="nav-tabs-custom">
    <ul class="nav nav-tabs">
      <li class="active"><a data-toggle="tab">Offerte {{entity.id}}</a></li>
      <li><a data-toggle="tab" *ngIf="project != null" (click)="openProject()">Projekt {{project.id}}</a></li>
      <li><a data-toggle="tab" *ngIf="project == null" (click)="createProject()"><i class="fa fa-fw fa-plus"></i>
        Projekt erstellen</a></li>
      <template [ngIf]="project != null && !project.invoices.isEmpty">
        <li *ngFor="let invoice of project.invoices">
          <a data-toggle="tab" (click)="openInvoice(invoice.id)">Rechnung {{invoice.id}}</a>
        </li>
      </template>
      <li>
        <a data-toggle="tab" *ngIf="project != null" (click)="createInvoice()">
          <i class="fa fa-fw fa-plus"></i>
          Rechnung erstellen
        </a>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane active" id="offer_tab">
        <div class="form-horizontal">
          <div class="form-group">
            <label class="col-sm-2 control-label">Name</label>

            <div class="col-sm-4">
              <input required="true" class="form-control" style="width: 100%;" type="text" [(ngModel)]="entity.name"
                     (change)="addSaveField('name')">
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-2 control-label">Kunde</label>
            <customer-select [required]="true" class="col-sm-4" [(selectedEntity)]="entity.customer"
                             (selectedEntityChange)="entity.addFieldtoUpdate('customer')"></customer-select>
          </div>
          <div class="form-group">
            <label class="col-sm-2 control-label">Status</label>
            <offerstatus-select class="col-sm-4" [(selectedEntity)]="entity.status" (selectedEntityChange)="entity.addFieldtoUpdate('status')"></offerstatus-select>
          </div>
          <div class="form-group">
            <label class="col-sm-2 control-label">Verantwortlicher Mitarbeiter</label>
            <user-select class="col-sm-4" [(selectedEntity)]="entity.accountant" (selectedEntityChange)="addSaveField('accountant')"></user-select>
          </div>
          <div class="form-group">
            <label class="col-sm-2 control-label">Gültig bis</label>
            <dateinput class="col-sm-4" [(date)]="entity.validTo" (dateChange)="addSaveField('validTo')"></dateinput>
          </div>
          <div class="form-group">
            <label class="col-sm-2 control-label">Tarif</label>
            <rategroup-select class="col-sm-4" [(selectedEntity)]="entity.rateGroup" (selectedEntityChange)="addSaveField('rateGroup')"></rategroup-select>
          </div>
          <h4>Addresse</h4>
          <address-edit [(address)]="entity.address" (change)="addSaveField('address')"></address-edit>
          <div class="form-horizontal">
            <div class="form-group">
              <label class="col-sm-2"></label>

              <div class="col-sm-4">
                <a (click)="copyAddressFromCustomer()" *ngIf="entity.customer != null">Adresse aus Kunde
                  übernehmen</a>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="control-label">Kurzbeschreibung</label>
          <input class="form-control" [(ngModel)]="entity.shortDescription" (change)="addSaveField('shortDescription')">
        </div>
        <div class="form-group">
          <label class="control-label">Beschreibung</label>
          <p class="help-block">Beschreibungstexte werden neu mit Markdown formatiert. <a target="_blank" href="https://github.com/stiftungswo/Dime/blob/master/doc/markdown_intro.md">Hilfe</a></p>
          <textarea class="form-control" [(ngModel)]="entity.description"
                    (change)="addSaveField('description')"></textarea>
        </div>
      </div>
    </div>
  </div>
  <offerposition-overview [offer]="entity.id"></offerposition-overview>
  <div class="row">
    <div class="col-md-12 right">
      <offerdiscount-overview [offer]="entity.id"></offerdiscount-overview>
    </div>
  </div>
  <div class="box box-primary">
    <div class="box-header with-border">
      <h3 class="box-title">Berechnung</h3>
    </div>
    <div class="box-body">
      <div class="row"><label class="col-sm-2 col-xs-6 control-label">Subtotal</label>
        <div class="col-sm-4 col-xs-6">{{entity.subtotal}}</div>
      </div>
      <div class="row"><label class="col-sm-2 col-xs-6 control-label">Davon Mwst.</label>
        <div class="col-sm-4 col-xs-6">{{entity.totalVAT}}</div>
      </div>
      <div class="row"><label class="col-sm-2 col-xs-6 control-label">Total Abzüge</label>
        <div class="col-sm-4 col-xs-6">{{entity.totalDiscounts}}</div>
      </div>
      <div class="row"><label class="col-sm-2 col-xs-6 control-label">Total</label>
        <div class="col-sm-4 col-xs-6">{{entity.total}}</div>
      </div>
      <div class="row">
        <label class="col-sm-2 control-label">Fixpreis</label>
        <div class="col-sm-4">
          <input class="form-control" type="text" [(ngModel)]="entity.fixedPrice" (change)="addSaveField('fixedPrice')">
        </div>
      </div>
    </div>
  </div>
  <div class="DimeControlButtons">
    <button type="button" class="btn btn-primary" (click)="saveEntity()">
      <error-icon value="saveState" timeout="20"></error-icon>
    </button>
    <button type="button" class="btn btn-primary" (click)="printOffer()"><span
            class="glyphicon glyphicon-print"></span> Drucken
    </button>
    <button type="button" class="btn btn-default" (click)="reloadEvict()"><span
            class="glyphicon glyphicon-refresh"></span></button>
  </div>
</form>