<div class="row" style="margin-bottom: 5px;">
    <div class="col-xs-12 col-sm-2"></div>
    <daterange class="col-xs-12 col-sm-8" [(startdate)]="filterStartDate" [(enddate)]="filterEndDate" [null-allowed]="true"></daterange>
</div>
<div class="text-muted" *ngIf="entities.length == 0">
    Keine Einträge
</div>
<table *ngIf="entities.length > 0" class="table table-bordered table-hover form" ngControlGroup="timeslices">
    <thead>
        <tr>
            <th style="width: 30px"></th>
            <th *ngIf="projectBased">Benutzer</th>
            <th class="col-sm-6">Aktivität</th>
            <th>Datum</th>
            <th>Dauer/Anzahl</th>
            <th width="60">Aktion</th>
        </tr>
    </thead>
    <tbody>
        <tr
          *ngFor="let entity of entities | timeslicedatefilter:filterStartDate:filterEndDate | orderBy:'startedAt'; let i = index"
          (click)="selectEntity(entity.id)"
          [ngClass]="rowClass(entity, row.valid)"
          ngControlGroup="position{{i}}"
          #row="ngForm">
            <td></td>
            <td *ngIf="projectBased"><user-select [(ngModel)]="entity.employee" [parentEmployees]="employees" (ngModelChange)="entity.addFieldtoUpdate('employee')"></user-select></td>
            <td><activity-select disabled [(ngModel)]="entity.activity" [parent-activities]="activities" [project]="entity?.project?.id" (ngModelChange)="entity.addFieldtoUpdate('activity')"></activity-select></td>
            <td><date-input disabled style="width: 100%;" [(ngModel)]="entity.startedAt"></date-input></td>
            <td validationStatus><input required ngControl="value{{i}}" class="form-control" [(ngModel)]="entity.value" (change)="addSaveField('value', entity)"/></td>
            <td><dime-button (click)="deleteEntity(entity.id)" fontAwesome="trash-o" color="red"></dime-button></td>
        </tr>
    </tbody>
</table>
<div class="DimeControlButtons container-inline">
    <div class="row form-inline">
        <div class="col-md-3">
            <label>Datum</label>
            <date-input [(ngModel)]="newEntryDate" [has-buttons]="true">
              <button class="btn" [class.btn-default]="!updateNewEntryDate" [class.btn-primary]="updateNewEntryDate"
                      data-toggle="tooltip" title="Stellt das Datum nach dem Erfassen auf das Datum des neusten Eintrags im ausgewaehlten Zeitfenster"
                      (click)="updateNewEntryDate = !updateNewEntryDate">
                Auto
                <i class="fa" [class.fa-check-square-o]="updateNewEntryDate" [class.fa-square-o]="!updateNewEntryDate"></i>
              </button>
            </date-input>
        </div>
        <div *ngIf="projectBased == true" class="col-md-2">
            <label>Benutzer</label>
            <user-select [clearOnClose]="false" [parentEmployees]="employees" [(ngModel)]="employee" [useContext]="false"></user-select>
        </div>
        <div *ngIf="projectBased == false" class="col-md-2">
            <label>Benutzer</label>
            <user-select [clearOnClose]="false" [(ngModel)]="employee" [useContext]="true"></user-select>
        </div>
        <div *ngIf="allowProjectSelect" class="col-md-4">
            <label>Projekt</label>
            <project-select [hideArchived]="true" [(ngModel)]="selectedProject"></project-select>
        </div>
        <div class="col-md-2">
            <label>Aktivität</label>
            <activity-select [(ngModel)]="selectedActivity" [parent-activities]="activities" [project]="selectedProject?.id" [shortname]="true"></activity-select>
        </div>
        <div class="col-md-1">
            <label>Wert</label>
            <setting-edit namespace="/usr/defaults/timeslice" name="value" defaultvalue="8.4h"></setting-edit>
        </div>
        <div class="col-md-12" style="margin-top: 5px;">
            <dime-button primary
                         (click)="createEntity()"
                         glyphicon="plus"
            >Eintrag hinzufügen</dime-button>
            <dime-button primary
                         (click)="duplicateEntity()"
                         [enabled]="selectedTimeslices.length == 1"
                         fontAwesome="copy"
                         tooltipText="Exakt ein (1) Eintrag muss ausgewählt sein."
            >Duplizieren</dime-button>
            <dime-button
                    [enabled]="moveDialogEnabled()"
                    glyphicon="arrow-right"
                    (click)="moveDialogVisible = !moveDialogVisible"
                    tooltipText="Verschiebe die ausgewählten Einträge in ein anderes Projekt"
            >Verschieben</dime-button>
            <dime-button
                    (click)="reloadEvict()"
                    glyphicon="refresh"></dime-button>
        </div>
        <div class="col-sm-12" style="padding-top: 10px" *ngIf="moveDialogVisible">
            <div class="clearfix"></div>
            <div class="panel panel-default">
                <div class="panel-heading">Verschieben</div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label>Projekt</label>
                            <project-select [hideArchived]="true" [(ngModel)]="moveTargetProject"></project-select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2" style="padding-top: 10px">
                            <dime-button glyphicon="arrow-right" (click)="moveTimeslices()" [enabled]="moveTargetProject != null" primary>Verschieben</dime-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
